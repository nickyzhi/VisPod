<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>VisPod</title>
        <link href="css/test.css" rel="stylesheet" type="text/css">
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
        <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
        <script src="js/functions.js"></script>
        <audio id="bgm" loop><source src="final_15.mp3"/></audio>
    </head>

    <body>
        <div id = "vispod">
            <img class = "logo" alt = "logo" src="pictures/logo.png" />
            <h2>The Model Health Show with Shawn Stevenson #80</h2>
            <div id = "content">
            </div>
            <div id = "playbutton">
                <img class="playpause"  src="pictures/play.ico" />
                <p class="sentenceContent"> This podcast of The Model Health Show is presented to you by Shawn Stevenson. 
                </p>
                
            </div>          
            <!-- <div id="dropdown">
                <button onclick="myFunction()" class="dropbtn">Similar Podcasts</button>
                  <div id="myDropdown" class="dropdown-content">
                    <input type="text" placeholder="Search.." id="myInput" onkeyup="filterFunction()">
                    <a href="#">TMHS 169: Don’t Just Sit There – With Katy Bowman</a>
                    <a href="#">TMHS 149: Why Great Sleep Is The Ultimate Fat Burner</a>
                    <a href="#">THMS 147: 10 Ways Sleep Can Give You A Better Brain</a>
                  </div>
            </div> -->
        </div>
    </body>

    <script>
        var bgm=document.getElementById("bgm");
        function bgmPlay(){bgm.play();}
        function bgmPause(){bgm.pause();} 
        var width = $("#content").width(),
            height = $("#content").height(),
            radius = (Math.min(width, height) / 2),
            out_padding = radius/6,
            inner_padding = radius/2.5;

        var color = d3.scale.category20();

        var arc = d3.svg.arc()
            .outerRadius(radius - out_padding)
            .innerRadius(radius - inner_padding);
        var pie = d3.layout.pie()
            .sort(null)
            .value(function(d) { return d.topicDuration; });
        
        // Define the div for the tooltip
        var profile_tooltip = d3.select("body").append("div")   
            .attr("class", "tooltip")               
            .style("opacity", 0)

        var svg = d3.select("#content")
            .append("svg")
            .attr("width", width)
            .attr("height", height)
                .append("g")
            .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

        
        var circlesData = [{ r: -10+(inner_padding-out_padding)/2}];

        var circleEnter = svg.selectAll(".profilecircle")
                          .data(circlesData)
                          .enter()
                          .append("g")

        var circle = circleEnter.append("circle")
            .attr("r", function(d){return d.r})
            .attr("cx",0)
            .attr("cy", function(d){return out_padding-radius-d.r} )
            .attr("class", "profilecircle"); 

        var images = circleEnter.append("image")
            .attr("xlink:href",  "pictures/Jade.png")
            .attr("x", function(d){return -d.r})
            .attr("y", function(d){return out_padding-radius-2*d.r})
            .attr("height",function(d){return 2*d.r} )
            .attr("width", function(d){return 2*d.r} )
            .attr("class", "profilecircle")
            .on("mouseover", function(d){
                profile_tooltip
                    .transition()
                    .duration(200)      
                    .style("opacity", .8);      
                profile_tooltip
                    .html("<a href='theshawnstevensonmodel.com'>" + images.attr('id') + "</a>")  
                    .style("left", (d3.event.pageX + 50) + "px")     
                    .style("top", (d3.event.pageY - 30) + "px") 
            })                  
            .on("mouseout", function(d) {       
                    profile_tooltip
                    .transition()        
                    .duration(500)      
                    .style("opacity", 0);   

            })
            .on("click", function(){
                window.open('http://www.theshawnstevensonmodel.com')
            });

        $(".playpause").click(function () {
            //click to play
            if (bgm.paused){
                bgmPlay();
                this.src = "pictures/pause.ico";
                var audio_duration = document.getElementById("bgm").duration;
                d3.timer(function() {
                    var currentTime = Math.floor(document.getElementById("bgm").currentTime);
                    //360 degree corresponding to the total duration time of audio
                    svg.selectAll(".profilecircle").attr("transform", function(d) {
                      return "rotate(" +  currentTime*360/audio_duration + ")";
                    });
                });
                
            }
            //click to pause
            else{
                bgmPause();
                this.src = "pictures/play.ico";

            }
        });



        d3.json('dataset.json', function(error, data) {
            if (error) throw error;

            var sentenceTime = [],
                sentenceContent = [],
                sentenceSpeaker = [],
                topicDuration = [0],
                topicTime = [],
                topicName = [];
            data.forEach(function(d,i) {
                d.topicDuration = +d.topicDuration;
                topicDuration.push(d.topicDuration);
                topicName.push(d.topicName);
                d.sentences.forEach(function(t){
                    sentenceTime.push(ParseTime(t.sentenceTime));
                    sentenceContent.push(t.sentenceContent);
                    sentenceSpeaker.push(t.sentenceSpeaker);
                });
            });
            //topicTime is accumulate topic duration time
            //an example of topicTime = [0, 280, 472, 570, 638, 808, 895]
            topicDuration.reduce(function(a,b,i) { return topicTime[i] = a+b; },0);
            console.log(topicTime)
            //draw donut
            var g = svg.selectAll(".arc")
                .data(pie(data))
                .enter().append("g")
                .attr("class", "arc");

            g.append("path")
                .attr("d", arc)
                .style("fill", function(d) { return color(d.data.topicName); });

 
            //draw topic and drag
            var group = svg.selectAll("draggroup").data(data).enter()
                .append("g")
                .attr("class", "topic_rects")

            // var draggroup = group.call(drag);


            if (typeof window.orientation !== 'undefined') {
                    var rect = group.append("rect")
                        .attr("x", function(d,i) { return i*140-radius+70; })
                        .attr("y", -radius - 1.5 * circlesData[0].r )
                        .attr("width", 150)
                        .attr("height", 50)
                        .attr("fill", function(d) { return color(d.topicName); })
                        .attr("class", "rect")
                        .attr("id", function(d) { return d.topicName.split(" ")[0]; })
                        .attr("class", "draggroup")
                        .style("margin-left","20px")
                        .on("click", function(d){
                            rectClickFunction(d);
                        });                        

                    var rectText = group.append("text")
                        .text(function(d) { return d.topicName; })
                        .attr("text-anchor", "middle")
                        .attr("x", function(d,i) { return i*140-radius+140; })
                        .attr("y", -radius - 1.5 * circlesData[0].r + 30)
                        .attr("font-size", "12px")
                        .attr("fill", "black")
                        .style("margin-left","20px")
                        .attr("class", "text")
                        .attr("id", function(d) { return d.topicName.split(" ")[0]; })
                        .attr("class", "draggroup")
                        .on("click", function(d){
                            rectClickFunction(d);
                        });
                }else{
                    var rect = group.append("rect")
                        .attr("x",  -radius-inner_padding-300)
                        .attr("y", function(d,i) { return i*60-radius+70; })
                        .attr("width", 180)
                        .attr("height", 50)
                        .attr("fill", function(d) { return color(d.topicName); })
                        .attr("class", "rect")
                        .attr("id", function(d) { return d.topicName.split(" ")[0]; })
                        .attr("class", "draggroup")
                        .on("click", function(d){
                            rectClickFunction(d);
                        });
                    var rectText = group.append("text")
                        .text(function(d) { return d.topicName; })
                        .attr("text-anchor", "middle")
                        .attr("x", -radius-inner_padding-205)
                        .attr("y", function(d,i) { return i*60-radius+100; })
                        .attr("font-size", "15px")
                        .attr("fill", "black")
                        .style("margin-left","50px")
                        .attr("class", "text")
                        .attr("id", function(d) { return d.topicName.split(" ")[0]; })
                        .attr("class", "draggroup")
                        .on("click", function(d){
                            rectClickFunction(d);
                        });
                }
                
            var rectClickFunction = function(d){
                $(".innercircle").css("display","none");
                var time = ParseTime(d.startTime);
                var audio_duration = document.getElementById("bgm").duration;
                document.getElementById("bgm").currentTime = time;
                svg.selectAll(".profilecircle").attr("transform", function(d) {
                  return "rotate(" +  time*360/audio_duration + ")";
                });
                var topicname = d.topicName.split(" ")[0];
                $("#"+topicname).clone().appendTo("body");
                d3.selectAll("#"+topicname).transition().attr("x","0").attr("y","0").transition().attr("display","none");

                var keywordsContent = d.keywords

                var innerCircleEnter = svg.selectAll("innercircle").data(keywordsContent)
                    .enter()
                    .append("g")
                    .attr("class", "innercircles");

                var circle_r = 90;
                var innerCircle = innerCircleEnter.append("circle")
                    .attr("r", function(d){return d.keywordScore*radius/(10*7)})
                    .attr("cx",function(d,i){return gen_x(i,circle_r)})
                    .attr("cy", function(d,i){return gen_y(i,circle_r)})
                    .attr("class", "innercircle")
                    .attr("fill",d3.selectAll("#"+topicname).style('fill'))
                    .attr("opacity",0)
                    .transition()
                    .duration(1300)
                    .attr("opacity",0.8);

                var innerText = innerCircleEnter.append("text")
                    .text(function(d) { return d.keyword})
                    .attr("text-anchor", "middle")
                    .attr("x", function(d,i){return gen_x(i,circle_r)})
                    .attr("y", function(d,i){return gen_y(i,circle_r)})
                    .attr("font-family", "sans-serif")
                    .attr("class", "innercircle")
                    .attr("font-size", function(d) { return d.keywordScore*radius/(200) + "px"; })
                    .attr("fill", "black")
                    .attr("opacity",0)
                    .transition()
                    .duration(1300)
                    .attr("opacity",0.8);
            }

            g.on("click", function(d) {
                    $(".innercircle").css("display","none");
                    var time = ParseTime(d.data.startTime);
                    console.log(d.data);
                    var audio_duration = document.getElementById("bgm").duration;
                    document.getElementById("bgm").currentTime = time;
                    svg.selectAll(".profilecircle").attr("transform", function(d) {
                      return "rotate(" +  time*360/audio_duration + ")";
                    });
                    var topicname = d.data.topicName.split(" ")[0];
                    d3.selectAll("#"+topicname).transition().attr("x","0").attr("y","0").transition().attr("display","none");

                    var keywordsContent = d.data.keywords

                    var innerCircleEnter = svg.selectAll("innercircle").data(keywordsContent)
                        .enter()
                        .append("g")
                        .attr("class", "innercircles");

                    var circle_r = 90;
                    var innerCircle = innerCircleEnter.append("circle")
                        .attr("r", function(d){return d.keywordScore*radius/(10*7)})
                        .attr("cx",function(d,i){return gen_x(i,circle_r)})
                        .attr("cy", function(d,i){return gen_y(i,circle_r)})
                        .attr("class", "innercircle")
                        .attr("fill",d3.selectAll("#"+topicname).style('fill'))
                        .attr("opacity",0)
                        .transition()
                        .duration(1300)
                        .attr("opacity",0.8);

                    var innerText = innerCircleEnter.append("text")
                        .text(function(d) { return d.keyword})
                        .attr("text-anchor", "middle")
                        .attr("x", function(d,i){return gen_x(i,circle_r)})
                        .attr("y", function(d,i){return gen_y(i,circle_r)})
                        .attr("font-family", "sans-serif")
                        .attr("class", "innercircle")
                        .attr("font-size", function(d) { return d.keywordScore*radius/(200) + "px"; })
                        .attr("fill", "black")
                        .attr("opacity",0)
                        .transition()
                        .duration(1300)
                        .attr("opacity",0.8);


                })
            //replace eq in jquery with d3 function
            d3.selection.prototype.eq = function(index) {  
              return d3.select(this[0][index]);
            }
            //console.log(d3.selectAll(".topic_rects").eq(1))
            //Update by d3 timer control
            d3.timer(function() {
                var currentTime = Math.floor(document.getElementById("bgm").currentTime);
                var sentence_index = Search(sentenceTime,currentTime);
                //update profile picture
                images.attr("xlink:href",  "pictures/"+sentenceSpeaker[sentence_index]+".png")
                      .attr("id", sentenceSpeaker[sentence_index]);
                //update transcript
                $("p").text(sentenceContent[sentence_index]);

                
            });

        });


    </script>
</html>


<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>test</title>
        <link href="css/test.css" rel="stylesheet" type="text/css">
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
        <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
        <audio id="bgm" loop><source src="80.mp3"/></audio>
    </head>
    <body>
        <div id = "vispod">
            <div id = "content">

            </div>

            <div id = "playbutton">
                <img class="playpause"  src="pictures/play.ico" />
                <p class="sentenceContent"> This podcast of The Model Health Show is presented to you by Shawn Stevenson. </p>
            </div>
        </div>
    </body>

    <script>
        var bgm=document.getElementById("bgm");
        function bgmPlay(){bgm.play();}
        function bgmPause(){bgm.pause();} 
        var width = $("#content").width(),
            height = $("#content").height(),
            radius = (Math.min(width, height) / 2),
            out_padding = 50,
            inner_padding = 110;

        var color = d3.scale.category20();

        var arc = d3.svg.arc()
            .outerRadius(radius - out_padding)
            .innerRadius(radius - inner_padding);
        var pie = d3.layout.pie()
            .sort(null)
            .value(function(d) { return d.topicDuration; });

        var svg = d3.select("#content")
            .append("svg")
            .attr("width", width)
            .attr("height", height)
                .append("g")
            .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

        
        var circlesData = [{ r: 25},];

        var circleEnter = svg.selectAll(".circle").data(circlesData).enter().append("g").attr("class", "circle")

        var circle = circleEnter.append("circle")
            .attr("r", function(d){return d.r})
            .attr("cx",0)
            .attr("cy", function(d){return out_padding-radius-d.r} )
            .attr("class", "circle");
    

        var images = circleEnter.append("image")
            .attr("xlink:href",  "test.jpeg")
            .attr("x", function(d){return -d.r})
            .attr("y", function(d){return out_padding-radius-2*d.r})
            .attr("height",function(d){return 2*d.r} )
            .attr("width", function(d){return 2*d.r} )
            .attr("class", "circle");
        //start time
        var t0 = Math.floor('0');

        $(".playpause").click(function () {
            //click to play
            if (bgm.paused){
                bgmPlay();
                this.src = "pictures/pause.ico";
                d3.timer(function() {
                    var currentTime = Math.floor(document.getElementById("bgm").currentTime*1000);
                    //44917 -- 500, 3491000 for whole episode
                    svg.selectAll(".circle").attr("transform", function(d) {
                      return "rotate(" +  currentTime/(200) + ")";
                });
            });
            }
            //click to pause
            else{
                bgmPause();
                this.src = "pictures/play.ico";
            }
        });

        function dragmove() {
          d3.select(this).attr({ x: width/2, y: height/2});
          var x = d3.event.x;
          var y = d3.event.y;
          d3.select(this).attr("transform", "translate(" + x + "," + y + ")");
        }
 
        var drag = d3.behavior.drag()
            .on("drag", dragmove);
 
        function explode(d){
            d3.select(this).style("display","none");
            createCircle(0, 300, 20, "yellow");
            createCircle(0, 400, 15, "yellow");
            createCircle(0, 350, 30, "yellow");
        }
        function createCircle(x, y, radius, color){
            var circle = svg.append("circle")
                .attr({r: 0, fill: color})
                .attr("transform", "translate(" + x + "," + y + ")")
                .attr("opacity",0);
            circle
                .transition()
                .duration(1300)
                .attr({r: radius})
                .attr("opacity",0.8)
        }




        d3.json('dataset.json', function(error, data) {
            if (error) throw error;
            data.forEach(function(d) {
                d.topicDuration = +d.topicDuration;
            });

            var g = svg.selectAll(".arc")
                .data(pie(data))
                .enter().append("g")
                .attr("class", "arc");

            g.append("path")
            .attr("d", arc)
            .style("fill", function(d) { return color(d.data.topicName); });

            var group = svg.selectAll("drag").data(data).enter()
                .append("g").call(drag);

            var rect = group.append("rect")
                .attr("x",  radius+inner_padding)
                .attr("y", function(d,i) { return i*60-radius+70; })
                .attr("width", 120)
                .attr("height", 50)
                .attr("fill", function(d) { return color(d.topicName); })
                .attr("class", "rect")
                .attr("class", "drag");

            //var textEnter = svg.selectAll(".text").data(data).enter().append("g")

            var rectText = group.append("text")
                .text(function(d) { return d.topicName; })
                .attr("text-anchor", "middle")
                .attr("x", radius+out_padding+120)
                .attr("y", function(d,i) { return i*60-radius+100; })
                .attr("font-family", "sans-serif")
                .attr("font-size", "20px")
                .attr("fill", "black")
                .attr("class", "text")
                .attr("class", "drag");


        });


    </script>
</html>


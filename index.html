<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>test</title>
        <link href="css/test.css" rel="stylesheet" type="text/css">
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
        <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
        <script src="js/gen_xy.js"></script>
        <audio id="bgm" loop><source src="pod_demo_5.mp3"/></audio>
        <script src="js/dropdown.js"></script>
        <audio id="bgm" loop><source src="80.mp3"/></audio>
    </head>
    <body>
        <div id = "vispod">
            <h1>VISPOD: Visualizing Podcast Content</h1>
            <div id = "content">
            </div>
            <div id = "playbutton">
                <img class="playpause"  src="pictures/play.ico" />
                <p class="sentenceContent"> This podcast of The Model Health Show is presented to you by Shawn Stevenson. </p>
            </div>          
            <div id="dropdown">
                <button onclick="myFunction()" class="dropbtn">Similar Podcasts</button>
                  <div id="myDropdown" class="dropdown-content">
                    <input type="text" placeholder="Search.." id="myInput" onkeyup="filterFunction()">
                    <a href="#">TMHS 169: Don’t Just Sit There – With Katy Bowman</a>
                    <a href="#">TMHS 149: Why Great Sleep Is The Ultimate Fat Burner</a>
                    <a href="#">THMS 147: 10 Ways Sleep Can Give You A Better Brain</a>
                  </div>
            </div>
        </div>
    </body>

    <script>
        var bgm=document.getElementById("bgm");
        function bgmPlay(){bgm.play();}
        function bgmPause(){bgm.pause();} 
        var width = $("#content").width(),
            height = $("#content").height(),
            radius = (Math.min(width, height) / 2),
            out_padding = radius/6,
            inner_padding = radius/2.5;

        var color = d3.scale.category20();

        var arc = d3.svg.arc()
            .outerRadius(radius - out_padding)
            .innerRadius(radius - inner_padding);
        var pie = d3.layout.pie()
            .sort(null)
            .value(function(d) { return d.topicDuration; });

        var svg = d3.select("#content")
            .append("svg")
            .attr("width", width)
            .attr("height", height)
                .append("g")
            .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

        
        var circlesData = [{ r: -10+(inner_padding-out_padding)/2},];

        var circleEnter = svg.selectAll(".profilecircle").data(circlesData).enter().append("g")

        var circle = circleEnter.append("circle")
            .attr("r", function(d){return d.r})
            .attr("cx",0)
            .attr("cy", function(d){return out_padding-radius-d.r} )
            .attr("class", "profilecircle");
    

        var images = circleEnter.append("image")
            .attr("xlink:href",  "pictures/Jade.png")
            .attr("x", function(d){return -d.r})
            .attr("y", function(d){return out_padding-radius-2*d.r})
            .attr("height",function(d){return 2*d.r} )
            .attr("width", function(d){return 2*d.r} )
            .attr("class", "profilecircle");

        $(".playpause").click(function () {
            //click to play
            if (bgm.paused){
                bgmPlay();
                this.src = "pictures/pause.ico";
                d3.timer(function() {
                    var currentTime = Math.floor(document.getElementById("bgm").currentTime*1000);
                    ///200,one circle is 36000, for 283000, which is a 5 mins audio
                    svg.selectAll(".profilecircle").attr("transform", function(d) {
                      return "rotate(" +  currentTime*36/(200*283) + ")";
                    });
                });
            }
            //click to pause
            else{
                bgmPause();
                this.src = "pictures/play.ico";
            }
        });
        d3.json('dataset.json', function(error, data) {
            if (error) throw error;

            var sentenceTime = [],
                sentenceContent = [],
                sentenceSpeaker = [],
                topicDuration = [0],
                topicTime = [],
                topicName = [];
            data.forEach(function(d,i) {
                d.topicDuration = +d.topicDuration;
                topicDuration.push(d.topicDuration);
                topicName.push(d.topicName);
                d.sentences.forEach(function(t){
                    sentenceTime.push(ParseTime(t.sentenceTime));
                    sentenceContent.push(t.sentenceContent);
                    sentenceSpeaker.push(t.sentenceSpeaker);
                });
            });
            //topicTime is accumulate topic duration time
            topicDuration.reduce(function(a,b,i) { return topicTime[i] = a+b; },0);
            //draw donut
            var g = svg.selectAll(".arc")
                .data(pie(data))
                .enter().append("g")
                .attr("class", "arc");

            g.append("path")
                .attr("d", arc)
                .style("fill", function(d) { return color(d.data.topicName); });

            var drag = d3.behavior.drag()
                .on("drag", dragmove)
                .on('dragend',explode);
 
            //draw topic and drag
            var group = svg.selectAll("draggroup").data(data).enter()
                .append("g")
            var draggroup = group.call(drag);

            var rect = group.append("rect")
                .attr("x",  radius+inner_padding)
                .attr("y", function(d,i) { return i*60-radius+70; })
                .attr("width", 130)
                .attr("height", 50)
                .attr("fill", function(d) { return color(d.topicName); })
                .attr("class", "rect")
                .attr("class", "draggroup");

            var rectText = group.append("text")
                .text(function(d) { return d.topicName; })
                .attr("text-anchor", "middle")
                .attr("x", radius+inner_padding+65)
                .attr("y", function(d,i) { return i*60-radius+100; })
                .attr("font-size", "18px")
                .attr("fill", "black")
                .style("margin-left","20px")
                .attr("class", "text")
                .attr("class", "draggroup");

             function dragmove() {
                d3.select(this).attr({ x: 0, y: 0});
                var x = d3.event.x ;
                var y = d3.event.y;
                d3.select(this).attr("transform", "translate(" + (x - width/2 + radius) + "," + (y+radius/2) + ")");
            }
            function explode(){
                d3.select(this).style("display","none");
                var keywordsContent = this.__data__.keywords

                var innerCircleEnter = svg.selectAll("innercircle").data(keywordsContent).enter().append("g");
                var circle_r = 90;
                var innerCircle = innerCircleEnter.append("circle")
                    .attr("r", function(d){return d.keywordScore*radius/(10*7)})
                    .attr("cx",function(d,i){return gen_x(i,circle_r)})
                    .attr("cy", function(d,i){return gen_y(i,circle_r)})
                    .attr("class", "innercircle")
                    .attr("fill",d3.select(this).select("rect").style('fill'))
                    .attr("opacity",0)
                        .transition()
                    .duration(1300)
                    .attr("opacity",0.8);

                var innerText = innerCircleEnter.append("text")
                    .text(function(d) { return d.keyword})
                    .attr("text-anchor", "middle")
                    .attr("x", function(d,i){return gen_x(i,circle_r)})
                    .attr("y", function(d,i){return gen_y(i,circle_r)})
                    .attr("font-family", "sans-serif")
                    .attr("font-size", function(d) { return d.keywordScore*radius/(200) + "px"; })
                    .attr("fill", "black")
                    .attr("opacity",0)
                        .transition()
                    .duration(1300)
                    .attr("opacity",0.8);
            }

            //update by d3 timer control
            d3.timer(function() {
                var currentTime = Math.floor(document.getElementById("bgm").currentTime*1000);
                var sentence_index = Search(sentenceTime,currentTime/1000);
                //update profile picture
                images.attr("xlink:href",  "pictures/"+sentenceSpeaker[sentence_index]+".png")
                //update transcript
                $("p").text(sentenceContent[sentence_index]);
                // var topic_index = Search(topicTime,currentTime/1000);
                // //console.log(topicTime,topicName[topic_index])
                // var topicContent = [currentTime,topicName[topic_index]];
                // if (topicContent != [currentTime-1,topicName[topic_index]]){

                // }
                // //console.log($(".text:contains(topicName[topic_index])").index())

                
            });

        });


    </script>
</html>

